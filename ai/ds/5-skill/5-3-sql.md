---
layout: post
title: SQL 结构化数据处理
---

本节基于 SQL 介绍一些基本的数据处理操作。我们首先介绍表格数据的基本特点，然后介绍基本的 SQL 概念，包括 select，group by，order by，join 等概念。

SQL 是处理结构化数据的。结构化数据，简单说，就是表格，有行，有列。比如说我们班上有 60 个同学，我们来用一个表格描述它。在这个表格里，每一个同学占一行，他有姓名、专业、年龄、籍贯等各种信息。这些信息，就是列。

我们首先看“行”。表格的一个记录，就是一行。为了操作表格的“行”，首先给“行”定义一个“主键”（Primary Key）。基于这个主键，可以区分每一行。因此，这个主键得是唯一的，不能重复，这样的话，我拿着这个主键一定能够找到某位同学，就像大家的身份证号码似的，不能重复。所以这个主键有时候就是一个数，一、二、三，每加入一行，它就自动加一，作为这一行的主键，这么往上排。而如果用大家的姓名做主键的话，是不行的，因为姓名的话有可能会重名。

因此，我们看到任何一个表，第一反应是找到它的主键。主键就像门的把手：你抓住了主键，就能够进房间，探索这一行的内容。

我们然后看“列”。我们的学生表包括下面的一些列：姓名、专业等。在不同的专业领域，“列”有不同的叫法。一种叫法是 Feature（特征）。这是我们做机器学习模型时，经常用的名字。另一种叫法是 Variable（变量）。这是我们在做统计学的工作时，一般用的名字。但对于表格数据来说，它就是一列，只不过是说法不一样，大家慢慢习惯。

我们下面来看表格的操作。我们用一个电影的打分表作为例子：

我们先介绍这一句：select * from ratings limit 5。首先，这个 ratings 就是这个表的名字，就是打分表。比如说，这个同学给这个电影打了一个分，五分。因此，这句话就很容易理解，就是从这个 rating 表里头选出（select）所有的（ 星号 * 是“通配符”，代表“所有的”）记录（就是“行”）。但是，因为表格里的记录可能很多，有几十万条呢。我只是想挑 5 条出来，看看。所以，我限制（limit）一下个数，只取出来五条。这句话就是这个意思，还简单吧？

我们再看这句：select count(*) as pop, movie_id from ratings group by movie_id order by pop desc limit 20;

这句就复杂一点，但没关系我们一起看。

首先，它有一个 group by。这是做一个“分组”：它根据 movie_id 给数据做了分组（group）。比如说，同学 A 看了《消失的你》，吓坏了，所以打了一个零分。但同学 B，很勇敢，她又去看，结果很喜欢，打了个五分。这时，如果你 select *，就能把这两个同学的打分记录都给挑出来嘛，对吧？但是现在你 group by，而且是用 movie_id 做group by，它就会把表里面的所有同一个电影（movie_id）的行，分为一组。所以，现在，这两个看了《消失的你》的同学的打分，就被分到了一组。然后另外两个同学可能给《长安十万里》打分了，就分到了另外一组。

group by 之后，在结果里，每一组会占一行。分完组之后，你看，这句 select 的不是 *，而是 select movie_id。所以，它会把每组的 movie_id 抽出来，所以这个结果里面就有每一组的 movie_id。比如《消失的你》是一行，《长安十万里》又有一行。

在一行里，除了 movie_id，还有一个特征（Feature）。它是什么呢？看，是 count(*)。这是一个函数。猜一猜，它是什么意思啊？对。它统计每一组里，“行”的条数。这就是“计数”（count）。所以，《消失的你》不是有两个人打分吗？所以这个 count 的结果就是 2，而《长安十万里》，假设有三个人打分，就是 3。

那么，count(*) 后面的 as 是什么意思呢？它是英文 alias 的缩写。alias 的意思是“别名”。所以就是说，我们给统计出来的“每组中的行数”这个特征，命一个别名，它就叫pop。它是“流行度”（popularity）的前三个字母，所以代表流行度。

所以，最终的结果，每一行，会有两列：movie_id, pop。这就是每个电影被打分的次数的统计。这就是 group by 和 count() 一起完成的功能。注意，这个例子是基于movie_id 这一个特征进行分组。你也可以用两个特征进行分组，group by 两个特征就行。group by 三个，都是可以的哦。

其次，我们再看 order_by。这个大家猜一猜，是干啥？排序，根据 pop 排序，而且是降序。然后挑最前面的 20 个，是吧？为什么我要降序，然后挑前 20 个呀？这样就挑出来最受欢迎的前 20 部电影了，对不对？

除了用 count 统计总数，我们还可以用 avg 算平均，用 max 算最大值，用 min 最小值。还有很多其它函数。注意，市面上有很多 SQL 数据库系统，比如 MySQL、PostgreSQL。虽然这些系统支持的函数大多数都相同，但也有一些函数不同。大家要看系统的说明书。一般来说，PostgreSQL 支持的函数比较多。

最后，我们看 where。它也是一个关键字，是用来做过滤的。它后面接一个布尔表达式。满足这个布尔表达式的行，就会被挑出来。所以，如果我们在 select 后加这样的一句：where watch_num > 20，那就是说：如果一行的 watch_num 这个特征超过 20，才满足要求，被挑出来。

<br/>

|[Index](../) | [Previous](5-1-sql) | [Next](5-3-sql) |
